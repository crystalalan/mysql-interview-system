<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多用户测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .data-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>🧪 多用户系统测试</h1>

    <div class="container">
        <h2>📊 系统状态</h2>
        <div id="systemStatus" class="status info">正在检查系统状态...</div>
        <button onclick="checkSystemStatus()">刷新状态</button>
        <button onclick="clearAllData()">清空所有数据</button>
    </div>

    <div class="container">
        <h2>👤 用户注册测试</h2>
        <div class="test-section">
            <h3>注册新用户</h3>
            <input type="text" id="regUsername" placeholder="用户名">
            <input type="email" id="regEmail" placeholder="邮箱">
            <input type="password" id="regPassword" placeholder="密码">
            <button onclick="testRegister()">注册用户</button>
        </div>
        <div id="registerResult"></div>
    </div>

    <div class="container">
        <h2>🔐 用户登录测试</h2>
        <div class="test-section">
            <h3>登录测试</h3>
            <input type="text" id="loginUsername" placeholder="用户名">
            <input type="password" id="loginPassword" placeholder="密码">
            <button onclick="testLogin()">登录</button>
            <button onclick="loginAsAdmin()">管理员登录</button>
        </div>
        <div id="loginResult"></div>
    </div>

    <div class="container">
        <h2>📝 面试申请测试</h2>
        <div class="test-section">
            <h3>提交面试申请</h3>
            <input type="text" id="interviewName" placeholder="姓名">
            <input type="tel" id="interviewPhone" placeholder="电话">
            <input type="email" id="interviewEmail" placeholder="邮箱">
            <input type="text" id="interviewPosition" placeholder="应聘职位">
            <textarea id="interviewExperience" placeholder="工作经验"></textarea>
            <button onclick="testSubmitInterview()">提交申请</button>
        </div>
        <div id="interviewResult"></div>
    </div>

    <div class="container">
        <h2>📋 数据查看测试</h2>
        <div class="test-section">
            <button onclick="viewMyInterviews()">查看我的面试</button>
            <button onclick="viewAllInterviews()">查看所有面试(管理员)</button>
            <button onclick="viewAllUsers()">查看所有用户</button>
        </div>
        <div id="dataResult" class="data-display"></div>
    </div>

    <div class="container">
        <h2>⚡ 实时测试指南</h2>
        <div class="status info">
            <strong>多设备测试步骤：</strong><br>
            1. 在设备A上注册用户并提交面试申请<br>
            2. 在设备B上使用管理员登录查看申请<br>
            3. 管理员审核申请<br>
            4. 在设备A上查看审核结果<br><br>
            <strong>管理员账户：</strong> admin / admin123
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        // 简单的云端数据库模拟
        class TestAPI {
            constructor() {
                this.storageKey = 'multiUserTestData';
                this.initializeData();
            }

            initializeData() {
                if (!localStorage.getItem(this.storageKey)) {
                    const initialData = {
                        users: [
                            {
                                id: 1,
                                username: 'admin',
                                email: 'admin@test.com',
                                password: btoa('admin123'),
                                role: 'admin',
                                created_at: new Date().toISOString()
                            }
                        ],
                        interviews: [],
                        nextUserId: 2,
                        nextInterviewId: 1
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(initialData));
                }
            }

            getData() {
                return JSON.parse(localStorage.getItem(this.storageKey));
            }

            saveData(data) {
                localStorage.setItem(this.storageKey, JSON.stringify(data));
                // 模拟云端同步
                this.broadcastUpdate();
            }

            broadcastUpdate() {
                // 模拟跨设备通信
                const event = new CustomEvent('dataUpdated', {
                    detail: { timestamp: new Date().toISOString() }
                });
                window.dispatchEvent(event);
            }

            generateToken(user) {
                const payload = {
                    id: user.id,
                    username: user.username,
                    role: user.role,
                    exp: Date.now() + 24 * 60 * 60 * 1000
                };
                return btoa(JSON.stringify(payload));
            }

            verifyToken(token) {
                try {
                    const payload = JSON.parse(atob(token));
                    if (payload.exp < Date.now()) return null;
                    return payload;
                } catch (error) {
                    return null;
                }
            }

            async register(userData) {
                const data = this.getData();

                const existingUser = data.users.find(u =>
                    u.username === userData.username || u.email === userData.email
                );

                if (existingUser) {
                    throw new Error('用户名或邮箱已存在');
                }

                const newUser = {
                    id: data.nextUserId,
                    username: userData.username,
                    email: userData.email,
                    password: btoa(userData.password),
                    role: 'user',
                    created_at: new Date().toISOString()
                };

                data.users.push(newUser);
                data.nextUserId++;
                this.saveData(data);

                return { message: '注册成功', userId: newUser.id };
            }

            async login(credentials) {
                const data = this.getData();
                const user = data.users.find(u => u.username === credentials.username);

                if (!user || atob(user.password) !== credentials.password) {
                    throw new Error('用户名或密码错误');
                }

                const token = this.generateToken(user);
                return {
                    token,
                    user: {
                        id: user.id,
                        username: user.username,
                        role: user.role
                    }
                };
            }

            async submitInterview(token, interviewData) {
                const userPayload = this.verifyToken(token);
                if (!userPayload) {
                    throw new Error('令牌无效或已过期');
                }

                const data = this.getData();

                const newInterview = {
                    id: data.nextInterviewId,
                    user_id: userPayload.id,
                    username: userPayload.username,
                    ...interviewData,
                    status: 'pending',
                    feedback: '',
                    created_at: new Date().toISOString()
                };

                data.interviews.push(newInterview);
                data.nextInterviewId++;
                this.saveData(data);

                return { message: '面试申请提交成功', interviewId: newInterview.id };
            }

            async getMyInterviews(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload) {
                    throw new Error('令牌无效或已过期');
                }

                const data = this.getData();
                return data.interviews.filter(interview => interview.user_id === userPayload.id);
            }

            async getAllInterviews(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload || userPayload.role !== 'admin') {
                    throw new Error('需要管理员权限');
                }

                const data = this.getData();
                return data.interviews;
            }

            async getAllUsers(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload || userPayload.role !== 'admin') {
                    throw new Error('需要管理员权限');
                }

                const data = this.getData();
                return data.users.map(u => ({
                    id: u.id,
                    username: u.username,
                    email: u.email,
                    role: u.role,
                    created_at: u.created_at
                }));
            }

            clearAllData() {
                localStorage.removeItem(this.storageKey);
                this.initializeData();
                this.broadcastUpdate();
            }
        }

        const testAPI = new TestAPI();

        // 监听数据更新
        window.addEventListener('dataUpdated', (event) => {
            showStatus('数据已更新: ' + event.detail.timestamp, 'info');
        });

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkSystemStatus() {
            const data = testAPI.getData();
            const status = `
系统状态: 正常运行
用户总数: ${data.users.length}
面试申请总数: ${data.interviews.length}
下一个用户ID: ${data.nextUserId}
下一个面试ID: ${data.nextInterviewId}
            `;
            showStatus(status, 'success');
        }

        async function testRegister() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                showResult('registerResult', '请填写所有字段', 'error');
                return;
            }

            try {
                const result = await testAPI.register({ username, email, password });
                showResult('registerResult', `注册成功! 用户ID: ${result.userId}`, 'success');

                // 清空表单
                document.getElementById('regUsername').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
            } catch (error) {
                showResult('registerResult', `注册失败: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showResult('loginResult', '请填写用户名和密码', 'error');
                return;
            }

            try {
                const result = await testAPI.login({ username, password });
                currentToken = result.token;
                currentUser = result.user;

                showResult('loginResult', `登录成功! 用户: ${result.user.username}, 角色: ${result.user.role}`, 'success');
            } catch (error) {
                showResult('loginResult', `登录失败: ${error.message}`, 'error');
            }
        }

        async function loginAsAdmin() {
            document.getElementById('loginUsername').value = 'admin';
            document.getElementById('loginPassword').value = 'admin123';
            await testLogin();
        }

        async function testSubmitInterview() {
            if (!currentToken) {
                showResult('interviewResult', '请先登录', 'error');
                return;
            }

            const interviewData = {
                name: document.getElementById('interviewName').value,
                phone: document.getElementById('interviewPhone').value,
                email: document.getElementById('interviewEmail').value,
                position: document.getElementById('interviewPosition').value,
                experience: document.getElementById('interviewExperience').value,
                skills: '测试技能',
                self_introduction: '测试自我介绍'
            };

            if (!interviewData.name || !interviewData.phone || !interviewData.email || !interviewData.position) {
                showResult('interviewResult', '请填写所有必填字段', 'error');
                return;
            }

            try {
                const result = await testAPI.submitInterview(currentToken, interviewData);
                showResult('interviewResult', `面试申请提交成功! ID: ${result.interviewId}`, 'success');

                // 清空表单
                document.getElementById('interviewName').value = '';
                document.getElementById('interviewPhone').value = '';
                document.getElementById('interviewEmail').value = '';
                document.getElementById('interviewPosition').value = '';
                document.getElementById('interviewExperience').value = '';
            } catch (error) {
                showResult('interviewResult', `提交失败: ${error.message}`, 'error');
            }
        }

        async function viewMyInterviews() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = '请先登录';
                return;
            }

            try {
                const interviews = await testAPI.getMyInterviews(currentToken);
                document.getElementById('dataResult').textContent =
                    `我的面试申请 (${interviews.length}条):\n\n` +
                    JSON.stringify(interviews, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `获取失败: ${error.message}`;
            }
        }

        async function viewAllInterviews() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = '请先登录';
                return;
            }

            try {
                const interviews = await testAPI.getAllInterviews(currentToken);
                document.getElementById('dataResult').textContent =
                    `所有面试申请 (${interviews.length}条):\n\n` +
                    JSON.stringify(interviews, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `获取失败: ${error.message}`;
            }
        }

        async function viewAllUsers() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = '请先登录';
                return;
            }

            try {
                const users = await testAPI.getAllUsers(currentToken);
                document.getElementById('dataResult').textContent =
                    `所有用户 (${users.length}个):\n\n` +
                    JSON.stringify(users, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `获取失败: ${error.message}`;
            }
        }

        function clearAllData() {
            if (confirm('确定要清空所有数据吗？这将删除所有用户和面试记录！')) {
                testAPI.clearAllData();
                currentToken = null;
                currentUser = null;
                showStatus('所有数据已清空，系统已重置', 'success');
                document.getElementById('dataResult').textContent = '';
                document.getElementById('loginResult').innerHTML = '';
                document.getElementById('registerResult').innerHTML = '';
                document.getElementById('interviewResult').innerHTML = '';
            }
        }

        // 页面加载时检查系统状态
        window.addEventListener('load', checkSystemStatus);
    </script>
</body>

</html>