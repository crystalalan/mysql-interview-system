<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ·æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .data-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸ§ª å¤šç”¨æˆ·ç³»ç»Ÿæµ‹è¯•</h1>

    <div class="container">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
        <div id="systemStatus" class="status info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
        <button onclick="checkSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>

    <div class="container">
        <h2>ğŸ‘¤ ç”¨æˆ·æ³¨å†Œæµ‹è¯•</h2>
        <div class="test-section">
            <h3>æ³¨å†Œæ–°ç”¨æˆ·</h3>
            <input type="text" id="regUsername" placeholder="ç”¨æˆ·å">
            <input type="email" id="regEmail" placeholder="é‚®ç®±">
            <input type="password" id="regPassword" placeholder="å¯†ç ">
            <button onclick="testRegister()">æ³¨å†Œç”¨æˆ·</button>
        </div>
        <div id="registerResult"></div>
    </div>

    <div class="container">
        <h2>ğŸ” ç”¨æˆ·ç™»å½•æµ‹è¯•</h2>
        <div class="test-section">
            <h3>ç™»å½•æµ‹è¯•</h3>
            <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="testLogin()">ç™»å½•</button>
            <button onclick="loginAsAdmin()">ç®¡ç†å‘˜ç™»å½•</button>
        </div>
        <div id="loginResult"></div>
    </div>

    <div class="container">
        <h2>ğŸ“ é¢è¯•ç”³è¯·æµ‹è¯•</h2>
        <div class="test-section">
            <h3>æäº¤é¢è¯•ç”³è¯·</h3>
            <input type="text" id="interviewName" placeholder="å§“å">
            <input type="tel" id="interviewPhone" placeholder="ç”µè¯">
            <input type="email" id="interviewEmail" placeholder="é‚®ç®±">
            <input type="text" id="interviewPosition" placeholder="åº”è˜èŒä½">
            <textarea id="interviewExperience" placeholder="å·¥ä½œç»éªŒ"></textarea>
            <button onclick="testSubmitInterview()">æäº¤ç”³è¯·</button>
        </div>
        <div id="interviewResult"></div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æ•°æ®æŸ¥çœ‹æµ‹è¯•</h2>
        <div class="test-section">
            <button onclick="viewMyInterviews()">æŸ¥çœ‹æˆ‘çš„é¢è¯•</button>
            <button onclick="viewAllInterviews()">æŸ¥çœ‹æ‰€æœ‰é¢è¯•(ç®¡ç†å‘˜)</button>
            <button onclick="viewAllUsers()">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·</button>
        </div>
        <div id="dataResult" class="data-display"></div>
    </div>

    <div class="container">
        <h2>âš¡ å®æ—¶æµ‹è¯•æŒ‡å—</h2>
        <div class="status info">
            <strong>å¤šè®¾å¤‡æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
            1. åœ¨è®¾å¤‡Aä¸Šæ³¨å†Œç”¨æˆ·å¹¶æäº¤é¢è¯•ç”³è¯·<br>
            2. åœ¨è®¾å¤‡Bä¸Šä½¿ç”¨ç®¡ç†å‘˜ç™»å½•æŸ¥çœ‹ç”³è¯·<br>
            3. ç®¡ç†å‘˜å®¡æ ¸ç”³è¯·<br>
            4. åœ¨è®¾å¤‡Aä¸ŠæŸ¥çœ‹å®¡æ ¸ç»“æœ<br><br>
            <strong>ç®¡ç†å‘˜è´¦æˆ·ï¼š</strong> admin / admin123
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        // ç®€å•çš„äº‘ç«¯æ•°æ®åº“æ¨¡æ‹Ÿ
        class TestAPI {
            constructor() {
                this.storageKey = 'multiUserTestData';
                this.initializeData();
            }

            initializeData() {
                if (!localStorage.getItem(this.storageKey)) {
                    const initialData = {
                        users: [
                            {
                                id: 1,
                                username: 'admin',
                                email: 'admin@test.com',
                                password: btoa('admin123'),
                                role: 'admin',
                                created_at: new Date().toISOString()
                            }
                        ],
                        interviews: [],
                        nextUserId: 2,
                        nextInterviewId: 1
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(initialData));
                }
            }

            getData() {
                return JSON.parse(localStorage.getItem(this.storageKey));
            }

            saveData(data) {
                localStorage.setItem(this.storageKey, JSON.stringify(data));
                // æ¨¡æ‹Ÿäº‘ç«¯åŒæ­¥
                this.broadcastUpdate();
            }

            broadcastUpdate() {
                // æ¨¡æ‹Ÿè·¨è®¾å¤‡é€šä¿¡
                const event = new CustomEvent('dataUpdated', {
                    detail: { timestamp: new Date().toISOString() }
                });
                window.dispatchEvent(event);
            }

            generateToken(user) {
                const payload = {
                    id: user.id,
                    username: user.username,
                    role: user.role,
                    exp: Date.now() + 24 * 60 * 60 * 1000
                };
                return btoa(JSON.stringify(payload));
            }

            verifyToken(token) {
                try {
                    const payload = JSON.parse(atob(token));
                    if (payload.exp < Date.now()) return null;
                    return payload;
                } catch (error) {
                    return null;
                }
            }

            async register(userData) {
                const data = this.getData();

                const existingUser = data.users.find(u =>
                    u.username === userData.username || u.email === userData.email
                );

                if (existingUser) {
                    throw new Error('ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨');
                }

                const newUser = {
                    id: data.nextUserId,
                    username: userData.username,
                    email: userData.email,
                    password: btoa(userData.password),
                    role: 'user',
                    created_at: new Date().toISOString()
                };

                data.users.push(newUser);
                data.nextUserId++;
                this.saveData(data);

                return { message: 'æ³¨å†ŒæˆåŠŸ', userId: newUser.id };
            }

            async login(credentials) {
                const data = this.getData();
                const user = data.users.find(u => u.username === credentials.username);

                if (!user || atob(user.password) !== credentials.password) {
                    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }

                const token = this.generateToken(user);
                return {
                    token,
                    user: {
                        id: user.id,
                        username: user.username,
                        role: user.role
                    }
                };
            }

            async submitInterview(token, interviewData) {
                const userPayload = this.verifyToken(token);
                if (!userPayload) {
                    throw new Error('ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ');
                }

                const data = this.getData();

                const newInterview = {
                    id: data.nextInterviewId,
                    user_id: userPayload.id,
                    username: userPayload.username,
                    ...interviewData,
                    status: 'pending',
                    feedback: '',
                    created_at: new Date().toISOString()
                };

                data.interviews.push(newInterview);
                data.nextInterviewId++;
                this.saveData(data);

                return { message: 'é¢è¯•ç”³è¯·æäº¤æˆåŠŸ', interviewId: newInterview.id };
            }

            async getMyInterviews(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload) {
                    throw new Error('ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ');
                }

                const data = this.getData();
                return data.interviews.filter(interview => interview.user_id === userPayload.id);
            }

            async getAllInterviews(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload || userPayload.role !== 'admin') {
                    throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™');
                }

                const data = this.getData();
                return data.interviews;
            }

            async getAllUsers(token) {
                const userPayload = this.verifyToken(token);
                if (!userPayload || userPayload.role !== 'admin') {
                    throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™');
                }

                const data = this.getData();
                return data.users.map(u => ({
                    id: u.id,
                    username: u.username,
                    email: u.email,
                    role: u.role,
                    created_at: u.created_at
                }));
            }

            clearAllData() {
                localStorage.removeItem(this.storageKey);
                this.initializeData();
                this.broadcastUpdate();
            }
        }

        const testAPI = new TestAPI();

        // ç›‘å¬æ•°æ®æ›´æ–°
        window.addEventListener('dataUpdated', (event) => {
            showStatus('æ•°æ®å·²æ›´æ–°: ' + event.detail.timestamp, 'info');
        });

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkSystemStatus() {
            const data = testAPI.getData();
            const status = `
ç³»ç»ŸçŠ¶æ€: æ­£å¸¸è¿è¡Œ
ç”¨æˆ·æ€»æ•°: ${data.users.length}
é¢è¯•ç”³è¯·æ€»æ•°: ${data.interviews.length}
ä¸‹ä¸€ä¸ªç”¨æˆ·ID: ${data.nextUserId}
ä¸‹ä¸€ä¸ªé¢è¯•ID: ${data.nextInterviewId}
            `;
            showStatus(status, 'success');
        }

        async function testRegister() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                showResult('registerResult', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            try {
                const result = await testAPI.register({ username, email, password });
                showResult('registerResult', `æ³¨å†ŒæˆåŠŸ! ç”¨æˆ·ID: ${result.userId}`, 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('regUsername').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
            } catch (error) {
                showResult('registerResult', `æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showResult('loginResult', 'è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            try {
                const result = await testAPI.login({ username, password });
                currentToken = result.token;
                currentUser = result.user;

                showResult('loginResult', `ç™»å½•æˆåŠŸ! ç”¨æˆ·: ${result.user.username}, è§’è‰²: ${result.user.role}`, 'success');
            } catch (error) {
                showResult('loginResult', `ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loginAsAdmin() {
            document.getElementById('loginUsername').value = 'admin';
            document.getElementById('loginPassword').value = 'admin123';
            await testLogin();
        }

        async function testSubmitInterview() {
            if (!currentToken) {
                showResult('interviewResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const interviewData = {
                name: document.getElementById('interviewName').value,
                phone: document.getElementById('interviewPhone').value,
                email: document.getElementById('interviewEmail').value,
                position: document.getElementById('interviewPosition').value,
                experience: document.getElementById('interviewExperience').value,
                skills: 'æµ‹è¯•æŠ€èƒ½',
                self_introduction: 'æµ‹è¯•è‡ªæˆ‘ä»‹ç»'
            };

            if (!interviewData.name || !interviewData.phone || !interviewData.email || !interviewData.position) {
                showResult('interviewResult', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }

            try {
                const result = await testAPI.submitInterview(currentToken, interviewData);
                showResult('interviewResult', `é¢è¯•ç”³è¯·æäº¤æˆåŠŸ! ID: ${result.interviewId}`, 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('interviewName').value = '';
                document.getElementById('interviewPhone').value = '';
                document.getElementById('interviewEmail').value = '';
                document.getElementById('interviewPosition').value = '';
                document.getElementById('interviewExperience').value = '';
            } catch (error) {
                showResult('interviewResult', `æäº¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function viewMyInterviews() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = 'è¯·å…ˆç™»å½•';
                return;
            }

            try {
                const interviews = await testAPI.getMyInterviews(currentToken);
                document.getElementById('dataResult').textContent =
                    `æˆ‘çš„é¢è¯•ç”³è¯· (${interviews.length}æ¡):\n\n` +
                    JSON.stringify(interviews, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `è·å–å¤±è´¥: ${error.message}`;
            }
        }

        async function viewAllInterviews() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = 'è¯·å…ˆç™»å½•';
                return;
            }

            try {
                const interviews = await testAPI.getAllInterviews(currentToken);
                document.getElementById('dataResult').textContent =
                    `æ‰€æœ‰é¢è¯•ç”³è¯· (${interviews.length}æ¡):\n\n` +
                    JSON.stringify(interviews, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `è·å–å¤±è´¥: ${error.message}`;
            }
        }

        async function viewAllUsers() {
            if (!currentToken) {
                document.getElementById('dataResult').textContent = 'è¯·å…ˆç™»å½•';
                return;
            }

            try {
                const users = await testAPI.getAllUsers(currentToken);
                document.getElementById('dataResult').textContent =
                    `æ‰€æœ‰ç”¨æˆ· (${users.length}ä¸ª):\n\n` +
                    JSON.stringify(users, null, 2);
            } catch (error) {
                document.getElementById('dataResult').textContent = `è·å–å¤±è´¥: ${error.message}`;
            }
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·å’Œé¢è¯•è®°å½•ï¼')) {
                testAPI.clearAllData();
                currentToken = null;
                currentUser = null;
                showStatus('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼Œç³»ç»Ÿå·²é‡ç½®', 'success');
                document.getElementById('dataResult').textContent = '';
                document.getElementById('loginResult').innerHTML = '';
                document.getElementById('registerResult').innerHTML = '';
                document.getElementById('interviewResult').innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.addEventListener('load', checkSystemStatus);
    </script>
</body>

</html>